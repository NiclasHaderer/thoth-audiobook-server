#!/bin/sh

# Get previously staged kotlin files
STAGED_FILES=$(git diff --cached --name-only | while read -r filename; do if [ -f "$filename" ] && [ "${filename##*.}" = "kt" ]; then echo "$filename"; fi; done)
STAGED_FILES_CSV=$(echo "$STAGED_FILES" | paste -sd, -)
if [ -n "$STAGED_FILES" ]; then
    # Run ktfmt on staged files
    ./gradlew ktfmtPrecommit --include-only="$STAGED_FILES_CSV" > /dev/null 2>&1

    # Check if ktfmt made any changes (unstaged changes in staged files)
    if ! git diff --quiet -- "$STAGED_FILES"; then
        echo "Ktfmt has made changes to the following files:"
        echo "$STAGED_FILES"
        echo "Please review the changes and commit again."
        echo "$STAGED_FILES" | xargs git add
        exit 1
    fi
fi